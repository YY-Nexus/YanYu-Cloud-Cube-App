# CI/CD 自动化系统使用指南

## 概述

本项目实现了完整的自动化 CI/CD 系统，包括冲突解决、自动审核和持续集成功能。

## 🚀 主要功能

### 1. 自动冲突解决

- ✅ 自动检测和解决 merge 冲突
- ✅ 特别优化 pnpm-lock.yaml 冲突处理
- ✅ 智能处理格式异常的冲突标记
- ✅ 自动备份原文件

### 2. 智能 CI/CD 流程

- ✅ 多阶段质量检测（lint、test、build）
- ✅ TypeScript 类型检查（当前为信息性，不阻塞）
- ✅ 自动化测试执行
- ✅ 并行构建优化

### 3. 自动审核系统

- ✅ 实时质量门禁报告
- ✅ 自动审批小型变更（依赖更新、文档等）
- ✅ 交互式命令支持
- ✅ 智能合并决策

### 4. 分支保护与自动合并

- ✅ 自动分支保护规则设置
- ✅ 条件满足时自动合并
- ✅ 失败自动回滚和通知

## 🛠️ 可用命令

### PR 评论命令

在任何 PR 的评论中使用以下命令：

```bash
/autofix          # 自动修复 lint、格式和冲突
/fix-conflicts    # 仅解决冲突
```

### 本地开发命令

```bash
# 冲突解决
pnpm fix-conflicts              # 解决一般冲突
pnpm fix-pnpm-conflicts        # 解决 pnpm-lock.yaml 冲突

# 代码质量
pnpm lint                       # 检查代码规范
pnpm lint:fix                   # 自动修复代码规范
pnpm format                     # 格式化代码
pnpm type-check                 # TypeScript 类型检查
pnpm test                       # 运行测试
pnpm build                      # 构建项目
```

## 📋 工作流程

### 开发流程

1. **创建分支** → 开发功能
2. **提交代码** → 自动触发 CI
3. **质量检测** → 自动运行所有检查
4. **冲突处理** → 自动检测并解决冲突
5. **代码审核** → 自动或手动审核
6. **自动合并** → 满足条件时自动合并

### CI 阶段说明

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   冲突检测       │ →  │    质量检测       │ →  │   自动审核      │
│ - 检测 merge 冲突│    │ - Lint 检查      │    │ - 生成质量报告   │
│ - 自动解决冲突   │    │ - 单元测试       │    │ - 自动审批      │
│ - 提供手动命令   │    │ - 构建测试       │    │ - 条件合并      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 🎯 自动合并条件

PR 将在以下条件满足时自动合并：

- ✅ 所有 CI 检查通过
- ✅ 至少一个审批 OR 是自动化 PR
- ❌ 无 "changes requested" 状态
- ❌ 无合并冲突

### 自动合并的 PR 类型

- `dependabot/*` - Dependabot 依赖更新
- `renovate/*` - Renovate 依赖更新
- `chore/autofix*` - 自动修复 PR
- 标题以 `chore:` 或 `docs:` 开头的 PR
- 带有 `auto-merge` 标签的 PR

## 📊 质量门禁

### 必须通过（阻塞合并）

- ✅ Lint 检查
- ✅ 单元测试
- ✅ 构建测试

### 信息性检查（不阻塞）

- ⚠️ TypeScript 类型检查（当前有已知问题）

## 🔧 冲突解决详情

### 支持的冲突类型

- ✅ 标准 Git 冲突标记
- ✅ pnpm-lock.yaml 依赖冲突
- ✅ 格式异常的冲突（缺少分隔符等）
- ✅ 空 HEAD 冲突

### 解决策略

1. **保留 HEAD 内容** - 保留当前分支更改
2. **删除冲突分支内容** - 删除传入分支更改
3. **清理冲突标记** - 完全移除所有冲突标记
4. **自动备份** - 处理前创建带时间戳的备份

### 手动解决复杂冲突

```bash
# 查看冲突文件
git status

# 使用自动解决脚本
bash scripts/auto-resolve-conflicts.sh [文件名]

# 查看备份文件
ls -la *.conflict-backup-*

# 手动编辑后重新安装依赖
pnpm install
```

## 🚨 故障排除

### 常见问题

**1. CI 失败：TypeScript 类型错误**

- **解决方案**：当前已知问题，不会阻塞 PR 合并
- **状态**：计划在后续版本修复

**2. 自动合并失败**

- **检查项**：确保所有状态检查通过
- **检查项**：确认有足够的审批
- **检查项**：检查是否有合并冲突

**3. 冲突解决失败**

```bash
# 手动运行冲突解决
pnpm fix-conflicts

# 检查备份文件
ls -la *.conflict-backup-*

# 如果失败，恢复备份文件
cp file.conflict-backup-TIMESTAMP file
```

**4. PR 未自动审批**

- **检查**：PR 类型是否在自动审批范围内
- **检查**：是否有 "changes requested" 状态
- **解决**：手动添加 `auto-merge` 标签

### 调试命令

```bash
# 调试冲突解决脚本
bash -x scripts/auto-resolve-conflicts.sh [文件]

# 检查 CI 状态
gh pr checks [PR号]

# 查看 PR 状态
gh pr view [PR号] --json statusCheckRollupState,reviewDecision
```

## 📈 最佳实践

### 开发建议

1. **小而频繁的提交** - 便于自动化处理
2. **语义化提交信息** - 便于自动分类
3. **及时处理冲突** - 使用提供的自动化工具
4. **关注 CI 反馈** - 及时修复质量问题

### 分支命名规范

```
feature/功能名称     # 新功能
bugfix/问题描述      # 错误修复
chore/维护任务       # 维护任务（自动合并）
docs/文档更新        # 文档更新（自动合并）
hotfix/紧急修复      # 紧急修复
```

### 提交信息规范

```
feat: 添加新功能
fix: 修复错误
docs: 更新文档
style: 代码格式化
refactor: 代码重构
test: 添加测试
chore: 维护任务
```

## 🔄 持续改进

### 已实现功能

- [x] 自动冲突解决
- [x] 智能 CI/CD 流程
- [x] 自动审核系统
- [x] 分支保护机制
- [x] 交互式命令

### 计划改进

- [ ] 修复 TypeScript 类型问题
- [ ] 增强冲突解决算法
- [ ] 添加性能测试
- [ ] 集成安全扫描
- [ ] 多环境部署自动化

## 📞 获取帮助

如果遇到问题：

1. 查看本文档的故障排除部分
2. 检查 [CI/CD 详细文档](./ci-cd.md)
3. 查看 [冲突解决文档](./conflict-resolution.md)
4. 在 PR 中使用 `/autofix` 或 `/fix-conflicts` 命令
5. 联系开发团队获取支持
