# 冲突解决脚本文档

本项目提供了两个脚本来自动解决合并冲突，实现了问题陈述中要求的"删除冲突内容上面的部分"策略。

## 脚本概述

### 1. `auto-fix-pnpm-lock-conflicts.sh` - pnpm-lock.yaml 专用脚本

**用途**: 专门用于解决 `pnpm-lock.yaml` 文件中的合并冲突

**使用方法**:

```bash
cd /path/to/project
./scripts/auto-fix-pnpm-lock-conflicts.sh
```

**特点**:

- 专门优化用于处理 pnpm-lock.yaml 文件
- 自动备份原文件为 `.bak` 后缀
- 解决后建议运行 `pnpm install` 重新整理依赖

### 2. `auto-resolve-conflicts.sh` - 通用冲突解决脚本

**用途**: 处理任意文件中的合并冲突

**使用方法**:

处理特定文件:

```bash
./scripts/auto-resolve-conflicts.sh path/to/conflicted-file.yaml
```

处理所有冲突文件:

```bash
./scripts/auto-resolve-conflicts.sh
```

查看帮助:

```bash
./scripts/auto-resolve-conflicts.sh --help
```

**特点**:

- 支持多种文件类型 (.yaml, .yml, .json, .js, .ts, .jsx, .tsx, .md, .txt)
- 自动发现并处理项目中的所有冲突文件
- 排除 node_modules, .git, dist, build 等目录
- 为每个处理的文件创建 `.conflict-backup` 备份
- 根据文件类型提供相应的后续建议命令

## 冲突解决策略

两个脚本都实现了相同的冲突解决策略：**保留传入的更改，删除当前分支的更改**

### 冲突块结构

```
<<<<<<< HEAD (或当前分支名)
当前分支的内容 (将被删除)
=======
传入分支的内容 (将被保留)
>>>>>>> 传入分支名
```

### 解决后的结果

```
传入分支的内容 (被保留)
```

## 工作流程

1. **检测冲突**: 检查文件中是否存在冲突标记 (`<<<<<<<`, `=======`, `>>>>>>>`)
2. **备份文件**: 创建原文件的备份副本
3. **解析冲突块**: 识别每个冲突块的边界
4. **应用策略**: 保留 `=======` 和 `>>>>>>>` 之间的内容，删除其他部分
5. **清理标记**: 移除所有冲突标记
6. **验证结果**: 确认处理后的文件不再包含冲突标记

## 安全特性

- **自动备份**: 所有操作前都会自动创建备份文件
- **验证检查**: 处理后验证是否还有残留的冲突标记
- **错误处理**: 如果验证失败，会报告错误并保留备份文件
- **目录排除**: 自动排除 node_modules 等不应修改的目录

## 使用场景

### 场景 1: pnpm-lock.yaml 冲突

当从其他分支合并时，pnpm-lock.yaml 经常出现冲突。使用专用脚本：

```bash
./scripts/auto-fix-pnpm-lock-conflicts.sh
pnpm install  # 重新整理依赖关系
```

### 场景 2: 配置文件冲突

当配置文件有冲突时，使用通用脚本：

```bash
./scripts/auto-resolve-conflicts.sh config.json
```

### 场景 3: 批量解决所有冲突

当多个文件都有冲突时：

```bash
./scripts/auto-resolve-conflicts.sh
```

## 注意事项

1. **备份重要性**: 脚本会自动创建备份，但重要文件建议手动备份
2. **审查更改**: 解决冲突后建议审查更改内容确保符合预期
3. **测试验证**: 解决冲突后运行相应的测试确保功能正常
4. **依赖重新安装**: 对于依赖文件（如 pnpm-lock.yaml），解决后需要重新安装依赖

## 恢复操作

如果需要撤销自动解决的结果：

```bash
# 恢复 pnpm-lock.yaml
cp pnpm-lock.yaml.bak pnpm-lock.yaml

# 恢复其他文件
cp filename.conflict-backup filename
```

## 故障排除

### 问题：脚本报告仍有冲突标记

**原因**: 文件中可能包含复杂的嵌套冲突或格式异常的冲突标记
**解决**: 手动检查备份文件，使用文本编辑器手动解决

### 问题：处理后文件格式错误

**原因**: 冲突内容可能包含影响文件结构的重要信息
**解决**: 从备份文件恢复，手动解决冲突或检查冲突内容的重要性

### 问题：依赖安装失败

**原因**: 解决 pnpm-lock.yaml 冲突后可能需要清理缓存
**解决**:

```bash
rm -rf node_modules
pnpm install
```

## 扩展和定制

脚本设计为易于扩展。可以根据项目需要：

1. 修改支持的文件类型列表
2. 调整目录排除规则
3. 自定义备份文件后缀
4. 添加特定文件类型的后处理逻辑

---

这些脚本提供了一个自动化的解决方案来处理常见的合并冲突场景，特别是在团队协作和持续集成环境中非常有用。
