# è‡ªåŠ¨å†²çªè§£å†³ç³»ç»Ÿ

æœ¬é¡¹ç›®å®ç°äº†ä¸€å¥—å®Œæ•´çš„è‡ªåŠ¨å†²çªè§£å†³ç³»ç»Ÿï¼Œèƒ½å¤Ÿæ™ºèƒ½å¤„ç†Gitåˆå¹¶å†²çªï¼Œç‰¹åˆ«é’ˆå¯¹monorepoç¯å¢ƒä¸­çš„å¸¸è§å†²çªåœºæ™¯ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- **æ™ºèƒ½å†²çªæ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«ä¸åŒç±»å‹æ–‡ä»¶çš„å†²çª
- **æ–‡ä»¶ç±»å‹ç‰¹åŒ–å¤„ç†**: é’ˆå¯¹ä¸åŒæ–‡ä»¶ç±»å‹ä½¿ç”¨ä¸“é—¨çš„è§£å†³ç­–ç•¥
- **è‡ªåŠ¨å¤‡ä»½**: æ‰€æœ‰ä¿®æ”¹å‰è‡ªåŠ¨åˆ›å»ºå¤‡ä»½æ–‡ä»¶
- **CI/CDé›†æˆ**: GitHub Actionsè‡ªåŠ¨åŒ–å·¥ä½œæµ
- **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„æ“ä½œè®°å½•å’ŒçŠ¶æ€è¿½è¸ª

## ğŸ“ è„šæœ¬ç»„ä»¶

### 1. ä¸»è¦è„šæœ¬

#### `scripts/auto-fix-pnpm-lock-conflicts.sh`

- **åŠŸèƒ½**: ä¸“é—¨å¤„ç†pnpm-lock.yamlå’Œpackage.jsonå†²çª
- **ç‰¹æ€§**:
  - è·¨å¹³å°å…¼å®¹ï¼ˆmacOS/Linuxï¼‰
  - æ™ºèƒ½é‡æ–°ç”ŸæˆæŸåçš„lockfile
  - ä¾èµ–æ™ºèƒ½åˆå¹¶
  - å½©è‰²æ—¥å¿—è¾“å‡º

#### `scripts/auto-resolve-git-conflicts.sh`

- **åŠŸèƒ½**: å…¨é¢çš„Gitåˆå¹¶å†²çªè‡ªåŠ¨è§£å†³
- **æ”¯æŒæ–‡ä»¶ç±»å‹**:
  - `pnpm-lock.yaml`: é‡æ–°ç”Ÿæˆ
  - `package.json`: æ™ºèƒ½ä¾èµ–åˆå¹¶
  - JSONæ–‡ä»¶: æ ¼å¼éªŒè¯å’Œä¿®å¤
  - YAMLæ–‡ä»¶: å†²çªæ ‡è®°ç§»é™¤
  - Markdownæ–‡ä»¶: ä¿ç•™æ‰€æœ‰ç‰ˆæœ¬
  - ä»£ç æ–‡ä»¶: ä¿ç•™HEADç‰ˆæœ¬

#### `scripts/fix-pnpm-lockfile.py`

- **åŠŸèƒ½**: Pythonå®ç°çš„lockfileæ™ºèƒ½ä¿®å¤
- **ç‰¹æ€§**:
  - é‡å¤åŒ…å®šä¹‰æ£€æµ‹å’Œç§»é™¤
  - YAMLè¯­æ³•éªŒè¯
  - å†²çªæ ‡è®°æ¸…ç†

### 2. æµ‹è¯•è„šæœ¬

#### `scripts/test-conflict-resolution.sh`

- **åŠŸèƒ½**: è‡ªåŠ¨åŒ–æµ‹è¯•å†²çªè§£å†³åŠŸèƒ½
- **æµ‹è¯•è¦†ç›–**:
  - package.jsonå†²çª
  - pnpm-lock.yamlå†²çª
  - é…ç½®æ–‡ä»¶å†²çª
  - å¤‡ä»½åŠŸèƒ½éªŒè¯

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### æ‰‹åŠ¨ä½¿ç”¨

```bash
# ä¿®å¤pnpm lockfileå†²çª
./scripts/auto-fix-pnpm-lock-conflicts.sh

# è§£å†³Gitåˆå¹¶å†²çª
./scripts/auto-resolve-git-conflicts.sh

# è¿è¡Œæµ‹è¯•
./scripts/test-conflict-resolution.sh
```

### åœ¨Gitå·¥ä½œæµä¸­ä½¿ç”¨

```bash
# åœ¨é‡åˆ°åˆå¹¶å†²çªæ—¶
git merge feature-branch
# å¦‚æœå‡ºç°å†²çªï¼Œè‡ªåŠ¨è§£å†³
./scripts/auto-resolve-git-conflicts.sh
# å®Œæˆåˆå¹¶
git commit
```

### CI/CDè‡ªåŠ¨åŒ–

é¡¹ç›®é…ç½®äº†GitHub Actionså·¥ä½œæµ `.github/workflows/auto-resolve-conflicts.yml`ï¼Œä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è¿è¡Œï¼š

- Pushåˆ°main/developåˆ†æ”¯
- åˆ›å»ºPull Request
- æ‰‹åŠ¨è§¦å‘

## ğŸ“‹ å†²çªè§£å†³ç­–ç•¥

### æ–‡ä»¶ç±»å‹å¤„ç†ç­–ç•¥

| æ–‡ä»¶ç±»å‹                      | è§£å†³ç­–ç•¥ | è¯´æ˜                                     |
| ----------------------------- | -------- | ---------------------------------------- |
| `pnpm-lock.yaml`              | é‡æ–°ç”Ÿæˆ | åˆ é™¤æŸåæ–‡ä»¶ï¼Œè¿è¡Œ`pnpm install`é‡æ–°ç”Ÿæˆ |
| `package.json`                | æ™ºèƒ½åˆå¹¶ | åˆå¹¶dependencies, devDependenciesç­‰å­—æ®µ  |
| `*.json`                      | æ ¼å¼ä¿®å¤ | ç§»é™¤å†²çªæ ‡è®°ï¼ŒéªŒè¯JSONæ ¼å¼               |
| `*.yaml`/`*.yml`              | æ ‡è®°ç§»é™¤ | ç®€å•ç§»é™¤Gitå†²çªæ ‡è®°                      |
| `*.md`                        | ä¿ç•™å…¨éƒ¨ | ä¿ç•™ä¸¤ä¸ªç‰ˆæœ¬ï¼Œç”¨æ ‡è®°åˆ†éš”                 |
| `*.js`/`*.ts`/`*.jsx`/`*.tsx` | ä¿ç•™HEAD | é»˜è®¤ä½¿ç”¨HEADç‰ˆæœ¬                         |
| å…¶ä»–æ–‡ä»¶                      | æ ‡è®°ç§»é™¤ | ç§»é™¤Gitå†²çªæ ‡è®°                          |

### ç‰¹æ®Šå¤„ç†é€»è¾‘

#### pnpm-lock.yamlå¤„ç†

```bash
# æ£€æµ‹æŸå -> å¤‡ä»½ -> åˆ é™¤ -> é‡æ–°ç”Ÿæˆ
if [æŸåæ£€æµ‹]; then
  backup_file pnpm-lock.yaml
  rm pnpm-lock.yaml
  pnpm install
fi
```

#### package.jsonä¾èµ–åˆå¹¶

```javascript
// æ™ºèƒ½åˆå¹¶ä¾èµ–
const merged = {
  ...ours,
  dependencies: { ...ours.dependencies, ...theirs.dependencies },
  devDependencies: { ...ours.devDependencies, ...theirs.devDependencies },
}
```

## ğŸ—‚ï¸ å¤‡ä»½å’Œæ—¥å¿—

### å¤‡ä»½æ–‡ä»¶

- **ä½ç½®**: `.conflict-backups/`
- **å‘½å**: `åŸæ–‡ä»¶å.æ—¶é—´æˆ³.bak`
- **ä¿ç•™**: æ‰€æœ‰å†²çªè§£å†³å‰çš„åŸå§‹æ–‡ä»¶

### æ—¥å¿—æ–‡ä»¶

- `conflict-resolution.log`: åŸºç¡€å†²çªè§£å†³æ—¥å¿—
- `auto-merge-resolution.log`: Gitåˆå¹¶å†²çªè§£å†³æ—¥å¿—

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒä¾èµ–

- **å¿…éœ€**: `bash`, `git`
- **æ¨è**: `pnpm`, `node.js`, `python3`
- **å¯é€‰**: `npm`, `yarn`

### è‡ªå®šä¹‰é…ç½®

å¯ä»¥é€šè¿‡ä¿®æ”¹è„šæœ¬å¼€å¤´çš„é…ç½®å˜é‡æ¥è°ƒæ•´è¡Œä¸ºï¼š

```bash
# åœ¨auto-fix-pnpm-lock-conflicts.shä¸­
BACKUP_DIR=".conflict-backups"  # å¤‡ä»½ç›®å½•
LOG_FILE="conflict-resolution.log"  # æ—¥å¿—æ–‡ä»¶

# åœ¨auto-resolve-git-conflicts.shä¸­
BACKUP_DIR=".conflict-backups"
LOG_FILE="auto-merge-resolution.log"
```

## ğŸ§ª æµ‹è¯•éªŒè¯

è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./scripts/test-conflict-resolution.sh

# æ‰‹åŠ¨éªŒè¯ç‰¹å®šåœºæ™¯
echo '<<<<<<< HEAD
version1
=======
version2
>>>>>>> branch' > test.txt

./scripts/auto-resolve-git-conflicts.sh
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æƒé™é”™è¯¯**

   ```bash
   chmod +x scripts/*.sh
   ```

2. **pnpmæœªå®‰è£…**

   ```bash
   npm install -g pnpm@9.0.0
   ```

3. **Pythonè„šæœ¬å¤±è´¥**
   - ç¡®ä¿Python3å¯ç”¨
   - æ£€æŸ¥æ–‡ä»¶ç¼–ç ä¸ºUTF-8

4. **GitçŠ¶æ€å¼‚å¸¸**
   ```bash
   git status
   git diff --name-only --diff-filter=U
   ```

### å®‰å…¨è€ƒè™‘

- æ‰€æœ‰æ“ä½œéƒ½ä¼šåˆ›å»ºå¤‡ä»½æ–‡ä»¶
- å¯ä»¥é€šè¿‡å¤‡ä»½æ–‡ä»¶æ¢å¤åŸå§‹çŠ¶æ€
- CIç¯å¢ƒä¸­ä¼šä¸Šä¼ å¤‡ä»½æ–‡ä»¶ä½œä¸ºartifacts

## ğŸ“ è´¡çŒ®æŒ‡å—

### æ·»åŠ æ–°æ–‡ä»¶ç±»å‹æ”¯æŒ

1. åœ¨ `auto-resolve-git-conflicts.sh` ä¸­æ·»åŠ æ–°çš„ `resolve_*_conflict` å‡½æ•°
2. åœ¨ä¸»è¦çš„ `case` è¯­å¥ä¸­æ·»åŠ æ–‡ä»¶ç±»å‹åˆ¤æ–­
3. æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹

### æ”¹è¿›å†²çªè§£å†³ç­–ç•¥

1. ä¿®æ”¹å¯¹åº”çš„è§£å†³å‡½æ•°
2. æ›´æ–°æµ‹è¯•ç”¨ä¾‹
3. æ›´æ–°æ–‡æ¡£è¯´æ˜

## ğŸ“Š ç›‘æ§å’ŒæŒ‡æ ‡

GitHub Actionså·¥ä½œæµä¼šç”Ÿæˆä»¥ä¸‹è¾“å‡ºï¼š

- å†²çªè§£å†³æˆåŠŸç‡
- å¤„ç†çš„æ–‡ä»¶æ•°é‡
- å¤‡ä»½æ–‡ä»¶ç»Ÿè®¡
- æ„å»ºéªŒè¯ç»“æœ

å¯ä»¥é€šè¿‡Actionsé¡µé¢æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—å’Œä¸‹è½½ç›¸å…³artifactsã€‚
